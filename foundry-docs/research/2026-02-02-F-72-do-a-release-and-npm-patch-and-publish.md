# Research: Do a release and npm patch and publish

**Issue**: F-72  
**Date**: 2026-02-02  
**Status**: Complete

## Summary

We need an automated release flow that (1) bumps the npm package version (at least `patch`), (2) creates a git tag / GitHub Release, and (3) publishes to npm. Today, CI and npm publishing exist, but publishing is only triggered by a GitHub Release, which implies the release must be created correctly (with a matching version) before `npm publish` can succeed.

## Requirements Analysis

From the issue description:
- “Do a release and npm patch and publish”
  - There should be a repeatable way to publish `@leixusam/foundry` to npm that increments the patch version.
  - The version in `package.json` / `package-lock.json` must match what gets published.
  - A tag / GitHub Release should be created as part of the same flow (or as an artifact of it).
- “Should be part of our cicd in GitHub action”
  - Release/publish should run in GitHub Actions rather than being entirely manual.

Implicit success criteria:
- A maintainer can trigger a release without doing local manual `npm version` + `npm publish`.
- Broken builds/tests block publishing.
- The workflow is compatible with typical branch protection (PR-only merges to `main`) or explicitly documents if it requires direct pushes.

## Codebase Analysis

### Relevant Files
- `.github/workflows/ci.yml` - Runs `build`, `typecheck`, and `test` on PRs and pushes to `main`.
- `.github/workflows/publish.yml` - Publishes to npm on `release: published` using `secrets.NPM_TOKEN`.
- `package.json` - Defines package name/version (`@leixusam/foundry`, currently `0.1.9`), build scripts, and `publishConfig`.
- `package-lock.json` - Needs version bumps alongside `package.json` to keep installs consistent.

### Existing Patterns
- CI gates: the repo already runs `npm run build`, `npm run typecheck`, and `npm test` in GitHub Actions.
- Publish gating: publish workflow repeats the same checks before running `npm publish`.

### Dependencies
- GitHub Actions for CI/CD.
- npm auth via `NPM_TOKEN` repository secret (required by `.github/workflows/publish.yml`).
- Git tags exist (`v0.1.1` … `v0.1.9`), suggesting releases are (at least sometimes) tag-based.

## Implementation Considerations

### Key Constraint: “release-created-by-workflow” triggers

If we keep the current two-workflow model (“create GitHub Release” → publish workflow runs on `release: published`), note that GitHub suppresses workflow triggers for events generated by `GITHUB_TOKEN` in another workflow (to prevent infinite loops). In practice, this means a workflow-created GitHub Release may not trigger `.github/workflows/publish.yml` unless the release/tag creation uses a different token (PAT or GitHub App token) or we restructure triggers.

### Approach (Recommended): Single “Release” workflow that does bump + tag + release + publish

Add a new workflow (e.g. `.github/workflows/release.yml`) triggered by `workflow_dispatch`:
1. Checkout + setup node
2. `npm ci`
3. `npm run build`, `npm run typecheck`, `npm test`
4. `npm version patch` (or accept an input: `patch|minor|major`)
5. Push commit + tag back to `main` (`contents: write`)
6. Create a GitHub Release for the tag (generate notes)
7. `npm publish --access public` with `NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}`

This avoids relying on cross-workflow triggers and is easiest to reason about: one run produces one npm publish.

Notes:
- If `main` is protected from direct pushes, this approach will require either (a) configuring the workflow token to bypass protections, or (b) switching to the PR-based approach below.
- Consider adding a concurrency group to prevent two releases from running simultaneously.

### Alternative: PR-based “Version bump” + publish on merge

If `main` is PR-only / protected:
1. A `workflow_dispatch` job creates a PR that bumps the version (patch/minor/major).
2. After merge to `main`, a publish workflow (triggered by `push` to `main`) detects the version bump and publishes + tags + creates release.

This pattern works well with protected branches, but it adds an extra step (merge the bump PR) and needs logic to decide when to publish.

### What to do with existing `.github/workflows/publish.yml`

Options:
- Replace/retire it (recommended) if the new release workflow does publishing directly.
- Keep it but change its trigger to `workflow_run` (run after `Release` workflow succeeds) rather than `release: published`.
- Keep it as-is only if release creation remains manual.

### Risks
- **Branch protection**: pushing version commits/tags from Actions may fail or be disallowed depending on repo settings.
- **Loop / duplicate publishes**: if publish triggers are broadened (e.g., push to main + release), ensure only one path can publish.
- **Version mismatch**: `npm publish` will fail if the version already exists on npm; workflow must bump version before publishing.
- **Token scope**: npm publishing requires `NPM_TOKEN`; GitHub release/tagging requires `contents: write` permissions.

### Testing Strategy
- Local dry run:
  - `npm ci && npm run build && npm run typecheck && npm test`
  - `npm pack` to verify published files include `dist/**/*` and `prompts/**/*`.
- GitHub verification:
  - Trigger the release workflow in Actions and confirm it:
    - bumps version in `package.json` and `package-lock.json`
    - creates tag `vX.Y.Z`
    - creates a GitHub Release
    - publishes `@leixusam/foundry@X.Y.Z` to npm

## Specification Assessment

This is CI/CD automation work with no user-facing UX changes.

**Needs Specification**: No

## Questions for Human Review

- Should releasing be manual (`workflow_dispatch`) or automatic on every merge to `main`?
- Is `main` protected against direct pushes (requiring a PR-based version bump)?
- Should the release workflow support `minor`/`major` bumps, or patch-only for now?
- Do we want npm provenance (`npm publish --provenance`) and the required `id-token: write` permissions?

## Next Steps

Ready for planning phase: decide on the preferred release strategy (single workflow vs PR-based), then implement the corresponding GitHub Actions workflow changes.

